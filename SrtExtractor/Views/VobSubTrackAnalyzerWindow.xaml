<Window x:Class="SrtExtractor.Views.VobSubTrackAnalyzerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SrtExtractor.Views"
        xmlns:converters="clr-namespace:SrtExtractor.Converters"
        xmlns:ui="http://schemas.modernwpf.com/2019"
        mc:Ignorable="d"
        ui:WindowHelper.UseModernWindowStyle="True"
        Icon="pack://application:,,,/SrtExtractor.ico"
        Title="VobSub Track Analyzer" 
        Height="700" Width="1100"
        MinHeight="600" MinWidth="900"
        WindowStartupLocation="CenterOwner">
    
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        
        <Style TargetType="Button">
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Margin" Value="4"/>
            <Setter Property="MinWidth" Value="120"/>
        </Style>
        
        <Style TargetType="GroupBox">
            <Setter Property="Margin" Value="4"/>
            <Setter Property="Padding" Value="8"/>
        </Style>
        
        <!-- DataGrid Selection Style -->
        <Style TargetType="DataGridRow">
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#FF0078D4"/>
                    <Setter Property="Foreground" Value="White"/>
                    <Setter Property="FontWeight" Value="Bold"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#FFE3F2FD"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header with Info -->
        <GroupBox Grid.Row="0">
            <GroupBox.Header>
                <StackPanel Orientation="Horizontal">
                    <TextBlock FontFamily="{StaticResource IconFontFamily}" 
                               Text="{StaticResource IconInfo}" 
                               FontSize="14" 
                               Margin="0,0,6,0"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="About This Tool" VerticalAlignment="Center"/>
                </StackPanel>
            </GroupBox.Header>
            <StackPanel>
                <TextBlock TextWrapping="Wrap" Margin="0,0,0,8">
                    <Run FontWeight="Bold">VobSub Track Analyzer</Run>
                    <LineBreak/>
                    This tool helps you identify VobSub (image-based) subtitle tracks in your MKV files.
                    Since VobSub requires OCR processing, we recommend using Subtitle Edit's batch converter.
                    <LineBreak/>
                    This analyzer shows the actual Matroska track numbers (what Subtitle Edit displays), and recommends tracks based on your preferences (Tools â†’ Options â†’ Subtitle Preferences).
                    <LineBreak/>
                    <Run FontWeight="Bold" Foreground="{StaticResource SuccessBrush}">âœ… Track numbers now match Subtitle Edit!</Run>
                    <Run>Use these track numbers to select the correct subtitles in Subtitle Edit's batch converter.</Run>
                </TextBlock>
            </StackPanel>
        </GroupBox>

        <!-- File/Folder Selection -->
        <GroupBox Grid.Row="1">
            <GroupBox.Header>
                <StackPanel Orientation="Horizontal">
                    <TextBlock FontFamily="{StaticResource IconFontFamily}" 
                               Text="{StaticResource IconFolder}" 
                               FontSize="14" 
                               Margin="0,0,6,0"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="File/Folder Selection" VerticalAlignment="Center"/>
                </StackPanel>
            </GroupBox.Header>
            <StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                    <Button Content="Select File..." 
                            Command="{Binding SelectFileCommand}"
                            Style="{StaticResource SecondaryButton}"
                            IsEnabled="{Binding IsNotScanning}"
                            ToolTip="Select a single MKV file to analyze"/>
                    <Button Content="Select Folder..." 
                            Command="{Binding SelectFolderCommand}"
                            Style="{StaticResource SecondaryButton}"
                            IsEnabled="{Binding IsNotScanning}"
                            ToolTip="Select a folder containing MKV files"/>
                    <TextBox Text="{Binding SelectedPath}" 
                             IsReadOnly="True" 
                             Margin="8,0"
                             VerticalAlignment="Center"
                             MinWidth="350"/>
                    <Button Command="{Binding ScanForVobSubTracksCommand}"
                            Style="{StaticResource PrimaryButton}"
                            IsEnabled="{Binding CanStartScan}"
                            Margin="8,0,0,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="{StaticResource IconFontFamily}" 
                                       Text="{StaticResource IconSearch}" 
                                       FontSize="16" 
                                       Margin="0,0,8,0"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="Scan for VobSub Tracks" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
                
                <CheckBox Content="Include subfolders" 
                          IsChecked="{Binding IncludeSubfolders}"
                          VerticalAlignment="Center"
                          IsEnabled="{Binding IsFolderSelected}"
                          ToolTip="Only applies when a folder is selected"
                          Margin="0,0,20,0"/>
            </StackPanel>
        </GroupBox>

        <!-- Main Content Area -->
        <Grid Grid.Row="2" Margin="4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Track List -->
            <GroupBox Header="ðŸŽ¬ VobSub Tracks Found" Grid.Column="0">
                <Grid>
                    <DataGrid ItemsSource="{Binding VobSubTracks}"
                              SelectedItem="{Binding SelectedTrack}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column"
                              SelectionMode="Single">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="File" 
                                                Binding="{Binding FileName}" 
                                                Width="*"/>
                            <DataGridTextColumn Header="Track #" 
                                                Binding="{Binding TrackNumber}" 
                                                Width="70"/>
                            <DataGridTextColumn Header="Language" 
                                                Binding="{Binding Language}" 
                                                Width="80"/>
                            <DataGridTextColumn Header="Type" 
                                                Binding="{Binding TrackType}" 
                                                Width="90"/>
                            <DataGridTextColumn Header="Title" 
                                                Binding="{Binding Title}" 
                                                Width="150"/>
                            <DataGridTextColumn Header="Codec" 
                                                Binding="{Binding Codec}" 
                                                Width="100"/>
                            <DataGridTextColumn Header="Recommendation" 
                                                Binding="{Binding RecommendationReason}" 
                                                Width="*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    
                    <!-- Empty State -->
                    <Border Background="{StaticResource BackgroundBrush}" 
                            BorderBrush="{StaticResource BorderBrush}" 
                            BorderThickness="1" 
                            CornerRadius="{StaticResource RadiusM}" 
                            Padding="{StaticResource ThicknessXXL}"
                            Visibility="{Binding HasVobSubTracks, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock FontFamily="{StaticResource IconFontFamily}" 
                                       Text="{StaticResource IconSearch}" 
                                       FontSize="48" 
                                       Foreground="{StaticResource TextTertiaryBrush}"
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,16"/>
                            <TextBlock Text="No VobSub tracks found" 
                                       FontSize="{StaticResource FontSizeSubtitle}" 
                                       FontWeight="{StaticResource FontWeightSemiBold}" 
                                       Foreground="{StaticResource TextPrimaryBrush}"
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="Select a file or folder and scan to find VobSub subtitle tracks" 
                                       FontSize="{StaticResource FontSizeSmall}" 
                                       Foreground="{StaticResource TextSecondaryBrush}" 
                                       HorizontalAlignment="Center"
                                       Margin="0,8,0,0"
                                       TextWrapping="Wrap"
                                       TextAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </GroupBox>

            <GridSplitter Grid.Column="1" 
                          Width="5" 
                          HorizontalAlignment="Stretch" 
                          Background="{StaticResource BorderBrush}"/>

            <!-- Analysis Panel -->
            <GroupBox Grid.Column="2">
                <GroupBox.Header>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="{StaticResource IconFontFamily}" 
                                   Text="{StaticResource IconInfo}" 
                                   FontSize="14" 
                                   Margin="0,0,6,0"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="Analysis Results" VerticalAlignment="Center"/>
                    </StackPanel>
                </GroupBox.Header>
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <TextBlock Text="{Binding AnalysisResults}" 
                               FontFamily="Consolas" 
                               FontSize="11"
                               TextWrapping="Wrap"
                               Padding="8"/>
                </ScrollViewer>
            </GroupBox>
        </Grid>

        <!-- Progress -->
        <GroupBox Header="â³ Progress" Grid.Row="3" 
                  Visibility="{Binding IsScanning, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                    <TextBlock Text="Scanning:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="{Binding CurrentFile}" 
                               FontWeight="Bold" 
                               VerticalAlignment="Center"
                               TextTrimming="CharacterEllipsis"/>
                </StackPanel>
                
                <ProgressBar Value="{Binding ProgressPercentage}" 
                             Height="20" 
                             Margin="0,0,0,4"/>
                
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <TextBlock Text="{Binding ProgressText}" 
                               FontSize="{StaticResource FontSizeSmall}" 
                               Foreground="{StaticResource TextSecondaryBrush}"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,8,0,0">
                    <TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{StaticResource TextPrimaryBrush}">
                        <Run Text="Files Scanned:"/>
                        <Run Text="{Binding TotalFiles}" FontWeight="Bold"/>
                        <Run Text=" | Files with VobSub:"/>
                        <Run Text="{Binding FilesWithVobSub}" FontWeight="Bold"/>
                    </TextBlock>
                </StackPanel>
            </StackPanel>
        </GroupBox>

        <!-- Actions -->
        <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button Command="{Binding CopyInstructionsCommand}"
                    Style="{StaticResource PrimaryButton}"
                    Padding="12,6"
                    IsEnabled="{Binding HasVobSubTracks}"
                    ToolTip="Copy Subtitle Edit batch conversion instructions to clipboard">
                <StackPanel Orientation="Horizontal">
                    <TextBlock FontFamily="{StaticResource IconFontFamily}" 
                               Text="{StaticResource IconCopy}" 
                               FontSize="14" 
                               Margin="0,0,8,0"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="Copy Instructions" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
            <Button Command="{Binding ExportReportCommand}"
                    Style="{StaticResource PrimaryButton}"
                    Padding="12,6"
                    IsEnabled="{Binding HasVobSubTracks}"
                    ToolTip="Export detailed analysis report to text file">
                <StackPanel Orientation="Horizontal">
                    <TextBlock FontFamily="{StaticResource IconFontFamily}" 
                               Text="{StaticResource IconSave}" 
                               FontSize="14" 
                               Margin="0,0,8,0"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="Export Report" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
            <Button Command="{Binding CancelScanCommand}"
                    Style="{StaticResource SecondaryButton}"
                    Padding="12,6"
                    IsEnabled="{Binding IsScanning}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock FontFamily="{StaticResource IconFontFamily}" 
                               Text="{StaticResource IconStop}" 
                               FontSize="14" 
                               Margin="0,0,8,0"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="Cancel Scan" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
            <Button Content="Close" 
                    Click="CloseButton_Click"
                    Style="{StaticResource SecondaryButton}"
                    Margin="10,0,0,0"/>
        </StackPanel>
    </Grid>
</Window>
